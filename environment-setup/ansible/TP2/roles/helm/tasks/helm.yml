- name: Download Helm installation script
  get_url:
    url: https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: "0755"

- name: Run Helm installation script
  shell: /tmp/get_helm.sh
  args:
    creates: /bin/helm
  register: helm_install_result
  changed_when: false

- name: Begin Installation of Helm
  become_user: "{{ rke_admin_user }}"
  block:
    - name: Add Rancher to helm
      shell: helm repo add rancher-stable https://releases.rancher.com/server-charts/stable --force-update
      changed_when: false

    - name: Add Jetstack
      shell: helm repo add jetstack https://charts.jetstack.io --force-update

    - name: Helm Update repos
      shell: helm repo update

    - name: Helm Install Cert Manager
      shell: helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version {{ CERT_MANAGER_VERSION }} --set installCRDs=true
